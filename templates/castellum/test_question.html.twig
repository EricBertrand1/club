{% extends 'base.html.twig' %}
{% block title %}Castellum — Question {{ pos }}/{{ total }}{% endblock %}

{% block body %}
<style>
  /* Taille globale (un peu plus grosse mais raisonnable sur PC) */
  :root { --scale: 1.7; }
  .test-root { font-size: calc(1rem * var(--scale)); line-height: 1.4; }

  /* Layout plein écran, sans bloquer le scroll du document */
  .test-wrap { height: 100dvh; display: grid; grid-template-rows: auto 1fr; }

  .test-header { padding: 1rem; }

  /* Zone principale = grille en 3 lignes: énoncé / image / réponse */
  .test-main { min-height: 0; padding: 0 1rem 1rem; }
  .question-layout {
    height: 100%;
    max-width: 1100px;
    margin: 0 auto;
    display: grid;
    grid-template-rows: auto 1fr auto;
    gap: 1rem;
    min-height: 0; /* autorise les enfants à rétrécir */
  }

  /* Énoncé : peut scroller si très long (barre masquée) */
  .section-text {
    min-height: 0;
    max-height: 40vh;        /* borne pour ne pas manger toute la place */
    overflow: auto;
    -ms-overflow-style: none; scrollbar-width: none;
  }
  .section-text::-webkit-scrollbar { display: none; }

  /* Image : occupe tout l'espace restant, sans dépasser */
  .section-image {
    min-height: 0;
    display: flex; align-items: center; justify-content: center;
  }
  .q-image {
    max-height: 100%;
    max-width: 100%;
    width: auto; height: auto;
    object-fit: contain;
  }

  /* Zone réponse : toujours visible en bas */
  .section-answer { padding-top: .5rem; }

  /* Boutons / champs à l’échelle */
  .test-root .btn { font-size: 1em; padding: 0.6em 1em; }
  .test-root .form-control { font-size: 1em; padding: 0.8em 1em; height: auto; }

  /* Bande résultat (couleurs claires) */
  .result-banner { font-weight: 700; border: 1px solid transparent; }
  .result-ok  { background-color: #d1e7dd; border-color: #badbcc; color: #0f5132; }
  .result-bad { background-color: #f8d7da; border-color: #f5c2c7; color: #842029; }
</style>

<div class="test-wrap test-root">
  <div class="test-header d-flex justify-content-between align-items-center">
    <div class="fw-bold">Question {{ pos }} / {{ total }}</div>
    <a class="btn btn-outline-secondary" href="{{ path('castellum_index') }}">Quitter</a>
  </div>

  <div class="test-main">
    <div class="question-layout card">
      <div class="card-body d-grid" style="grid-template-rows: auto 1fr auto; gap: 1rem; min-height: 0;">

        <!-- Énoncé -->
        <div class="section-text">
          <div class="fw-bold mb-2">Énoncé</div>
          <div style="white-space:pre-wrap;">{{ q.questionText }}</div>
        </div>

        <!-- Image (si présente) occupe l’espace restant -->
        {% if q.questionImage %}
          {% set src = q.questionImage starts with 'http' ? q.questionImage : asset(q.questionImage) %}
          <div class="section-image">
            <img src="{{ src }}" alt="" class="q-image img-fluid rounded border">
          </div>
        {% else %}
          <div class="section-image d-none"></div>
        {% endif %}

        <!-- Réponse / Résultat -->
        <div class="section-answer">
          {% if result is null %}
            <form method="post" action="{{ path('castellum_test_question', {pos: pos}) }}">
              <input type="hidden" name="_token" value="{{ csrf_token('castellum_answer_' ~ pos) }}">
              <label class="form-label">Votre réponse</label>
              <input type="text" name="answer" class="form-control" autofocus placeholder="Tapez votre réponse puis Entrée…">
              <div class="text-muted mt-2" style="font-size: .7em;">Appuyez sur <kbd>Entrée</kbd> pour valider.</div>
            </form>
          {% else %}
            <div class="result-banner {{ result.ok ? 'result-ok' : 'result-bad' }} mb-3 p-3 rounded">
              {{ result.ok ? 'Réponse juste' : 'Réponse fausse' }}
            </div>

            <div class="mb-2 {% if not result.ok %}opacity-50{% endif %}">
            <strong>Votre réponse :</strong> {{ result.user }}
          </div>

            {# Ne pas rappeler la réponse attendue si c'est juste #}
            {% if not result.ok %}
              <div class="mb-2"><strong>Réponse attendue :</strong> {{ result.expected }}</div>
            {% endif %}

            {% if result.explanation %}
              <div class="mt-3">
                <div class="fw-bold">Explication</div>
                <div style="white-space:pre-wrap;">{{ result.explanation }}</div>
              </div>
            {% endif %}

            <div class="d-flex justify-content-end mt-4">
              {% if pos < total %}
                <a class="btn btn-primary" href="{{ path('castellum_test_question', {pos: pos + 1}) }}">Question suivante</a>
              {% else %}
                <a class="btn btn-success" href="{{ path('castellum_test_result') }}">Terminer</a>
              {% endif %}
            </div>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}
