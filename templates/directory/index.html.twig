{% extends 'base.html.twig' %}
{% block title %}Annuaire{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    .dir-card{
      border:1px solid #e5e7eb; border-radius:.75rem; padding:1rem .95rem; background:#fff;
      display:flex; gap:1rem; align-items:flex-start;
    }
    .dir-badge{
      display:inline-block; padding:.15rem .5rem; border-radius:.35rem; font-size:.75rem; font-weight:600;
      background:#f3f4f6; color:#111827; border:1px solid #e5e7eb;
    }
    .dir-meta{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .dir-actions{ display:flex; gap:.4rem; flex-wrap:wrap; }
    .dir-stars{ font-size:1rem; letter-spacing:.05em; user-select:none; }
    .dir-star{ color:#9ca3af; }            /* creuse */
    .dir-star--full{ color:#FFD700; }      /* doré */
    .dir-muted{ color:#6b7280; }
    .dir-list{ display:grid; grid-template-columns:1fr; gap:.75rem; }
    @media (min-width: 720px){ .dir-list{ grid-template-columns:1fr; gap:1rem; } }

    .title-row{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
    .site-link{ font-size:.9rem; }
  </style>
{% endblock %}

{% block body %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 m-0">Annuaire</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary" href="{{ path('annuaire_new') }}">Nouvelle adresse</a>
      <a class="btn btn-outline-secondary" href="{{ path('app_home') }}">Quitter</a>
    </div>
  </div>

  {# Flashs #}
  {% for msg in app.flashes('success') %}
    <div class="alert alert-success">{{ msg }}</div>
  {% endfor %}
  {% for msg in app.flashes('danger') %}
    <div class="alert alert-danger">{{ msg }}</div>
  {% endfor %}

  {# ========= Filtres / Recherche ========= #}
  <form method="get" action="{{ path('annuaire_index') }}" class="card mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Catégorie</label>
          <select name="cat" class="form-select">
            <option value="" {% if f is not defined or f.cat is not defined or f.cat == '' %}selected{% endif %}>Toutes</option>
            {% for cat in categories %}
              <option value="{{ cat }}" {% if f is defined and f.cat is defined and f.cat == cat %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Type</label>
          <select name="type" class="form-select">
            <option value="" {% if f is not defined or f.type is not defined or f.type == '' %}selected{% endif %}>Tous</option>
            {% for t in types %}
              <option value="{{ t }}" {% if f is defined and f.type is defined and f.type == t %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Note minimale</label>
          <select name="min" class="form-select">
            {% set fmin = (f is defined and f.min is defined) ? (f.min ~ '') : '' %}
            {% set mins = ['', 0, 1, 2, 3, 4, 5] %}
            {% for m in mins %}
              {% if m is same as('') %}
                <option value="" {% if fmin == '' %}selected{% endif %}>Aucune</option>
              {% else %}
                {% set mm = m ~ '' %}
                <option value="{{ m }}" {% if fmin != '' and fmin == mm %}selected{% endif %}>≥ {{ m }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Recherche globale</label>
          <input type="text" class="form-control" name="q"
                 value="{{ f.q|default('') }}"
                 placeholder="Désignation, nom, ville, email, site…">
        </div>

        <div class="col-md-2">
          <label class="form-label">Mots (description)</label>
          <input type="text" class="form-control" name="desc"
                 value="{{ f.desc|default('') }}"
                 placeholder="Mots dans la description">
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary" type="submit">Filtrer</button>
        <a class="btn btn-outline-secondary" href="{{ path('annuaire_index') }}">Réinitialiser</a>
      </div>
    </div>
  </form>

  {# ========= Liste ========= #}
  {% if entries is empty %}
    <div class="text-muted">Aucune adresse pour le moment.</div>
  {% else %}
    <div class="dir-list">
      {% for a in entries %}
        {% set canEdit   = canEditById[a.id]|default(false) %}
        {% set canDelete = canDeleteById[a.id]|default(false) %}

        <div class="dir-card">
          <div class="flex-grow-1">
            <div class="d-flex align-items-start justify-content-between gap-2">
              <div>
                {# Titre : désignation sinon "Nom Prénom", sinon "Entrée #id" + lien site web à droite #}
                {% set title = a.designation ?? '' %}
                {% if title is empty %}
                  {% set title = a.lastName
                    ? a.lastName ~ (a.firstName ? ' ' ~ a.firstName : '')
                    : 'Entrée #' ~ a.id %}
                {% endif %}

                <div class="title-row">
                  <div class="h6 m-0">{{ title }}</div>
                  {% if a.website %}
                    <a class="site-link text-decoration-underline"
                       href="{{ a.website }}" target="_blank" rel="noopener">
                      site web
                    </a>
                  {% endif %}
                </div>

                <div class="dir-meta mt-1">
                  {% if a.category %}
                    <span class="dir-badge" title="Catégorie">{{ a.category }}</span>
                  {% endif %}
                  {% if a.type %}
                    <span class="dir-badge" title="Type">{{ a.type }}</span>
                  {% endif %}
                  <span class="dir-stars" title="Note">
                    {% set r = a.rating ?? 0 %}
                    {% for i in 1..5 %}
                      {% if i <= r %}
                        <span class="dir-star dir-star--full">★</span>
                      {% else %}
                        <span class="dir-star">☆</span>
                      {% endif %}
                    {% endfor %}
                  </span>
                </div>

                <div class="dir-muted small mt-2">
                  {% set line1 = a.address ?? '' %}
                  {% set line2 = (a.postalCode ?? '') ~ (a.city ? ' ' ~ a.city : '') %}
                  {% if line1 %}{{ line1 }}{% endif %}
                  {% if line2 %}{% if line1 %} — {% endif %}{{ line2 }}{% endif %}
                </div>

                {% if a.description %}
                  <div class="small mt-2">{{ a.description }}</div>
                {% endif %}
              </div>

              <div class="text-end">
                <div class="dir-actions">
                  {% if a.email %}
                    <a class="btn btn-sm btn-outline-secondary" href="mailto:{{ a.email }}">Email</a>
                  {% endif %}
                  {% if a.phone %}
                    <a class="btn btn-sm btn-outline-secondary" href="tel:{{ a.phone|replace({' ':'','-':'','.' : ''}) }}">Appeler</a>
                  {% endif %}
                  {# Le bouton "Site web" est retiré : le lien est désormais près du titre #}
                </div>

                <div class="mt-2 d-flex justify-content-end gap-2">
                  {% if canEdit %}
                    <a class="btn btn-sm btn-outline-secondary" href="{{ path('annuaire_edit', { id: a.id }) }}">Modifier</a>
                  {% endif %}
                  {% if canDelete %}
                    <form method="post"
                          action="{{ path('annuaire_delete', { id: a.id }) }}"
                          onsubmit="return confirm('Supprimer définitivement cette adresse ?');"
                          class="d-inline">
                      <input type="hidden" name="_token" value="{{ csrf_token('annuaire_delete_' ~ a.id) }}">
                      <button type="submit" class="btn btn-sm btn-outline-danger">Supprimer</button>
                    </form>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

      {% endfor %}
    </div>
  {% endif %}
</div>
{% endblock %}
