{% extends 'base.html.twig' %}
{% block title %}Annuaire{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    /* ===== Cartes compactes (2 lignes) ===== */
    .dir-list { display: grid; gap: .5rem; }
    .dir-card{
      border:1px solid #e5e7eb; border-radius:.6rem; background:#fff;
      padding:.55rem .75rem;
      display:flex; align-items:center; gap:.75rem;
    }
    .dir-main { flex:1 1 auto; min-width:0; }

    .dir-line1, .dir-line2 {
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      display:block; line-height:1.2;
    }
    .dir-line1 { font-weight:600; }

    .dir-title { margin-right:.5rem; }
    .dir-website { font-size:.9rem; text-decoration:underline; margin-right:.5rem; }

    .dir-stars { margin-left:.25rem; letter-spacing:.05em; user-select:none; }
    .dir-star { color:#9ca3af; }            /* creuse */
    .dir-star--full { color:#D4AF37; }      /* doré */

    .dir-pill {
      display:inline-block; font-size:.75rem; padding:.05rem .35rem;
      border:1px solid #e5e7eb; border-radius:999px; margin-right:.35rem; color:#374151;
      vertical-align:baseline;
    }
    .dir-dash { color:#9ca3af; margin:0 .25rem; }

    .dir-actions { display:flex; align-items:center; gap:.35rem; }
    .btn-skinny.btn-sm { padding:.1rem .45rem; line-height:1.1; }
  </style>
{% endblock %}

{% block body %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 m-0">Annuaire</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary" href="{{ path('annuaire_new') }}">Nouvelle adresse</a>
      <a class="btn btn-outline-secondary" href="{{ path('app_home') }}">Quitter</a>
    </div>
  </div>

  {# Flashs #}
  {% for msg in app.flashes('success') %}
    <div class="alert alert-success">{{ msg }}</div>
  {% endfor %}
  {% for msg in app.flashes('danger') %}
    <div class="alert alert-danger">{{ msg }}</div>
  {% endfor %}

  {# ========= Filtres / Recherche ========= #}
  <form method="get" action="{{ path('annuaire_index') }}" class="card mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Catégorie</label>
          <select name="cat" class="form-select">
            <option value="" {% if f is not defined or f.cat is not defined or f.cat == '' %}selected{% endif %}>Toutes</option>
            {% for cat in categories %}
              <option value="{{ cat }}" {% if f is defined and f.cat is defined and f.cat == cat %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Type</label>
          <select name="type" class="form-select">
            <option value="" {% if f is not defined or f.type is not defined or f.type == '' %}selected{% endif %}>Tous</option>
            {% for t in types %}
              <option value="{{ t }}" {% if f is defined and f.type is defined and f.type == t %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Note minimale</label>
          <select name="min" class="form-select">
            {% set fmin = (f is defined and f.min is defined) ? (f.min ~ '') : '' %}
            {% set mins = ['', 0, 1, 2, 3, 4, 5] %}
            {% for m in mins %}
              {% if m is same as('') %}
                <option value="" {% if fmin == '' %}selected{% endif %}>Aucune</option>
              {% else %}
                {% set mm = m ~ '' %}
                <option value="{{ m }}" {% if fmin != '' and fmin == mm %}selected{% endif %}>≥ {{ m }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div class="col-md-5">
          <label class="form-label">Recherche</label>
          <input
            type="text"
            class="form-control"
            name="q"
            value="{{ f.q|default('') }}"
            placeholder="Tapez un ou plusieurs mots (au moins un doit correspondre)…">
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary" type="submit">Filtrer</button>
        <a class="btn btn-outline-secondary" href="{{ path('annuaire_index') }}">Réinitialiser</a>
      </div>
    </div>
  </form>

  {# ========= Liste (compacte 2 lignes) ========= #}
  {% if entries is empty %}
    <div class="text-muted">Aucune adresse pour le moment.</div>
  {% else %}
    <div class="dir-list">
      {% for a in entries %}
        {% set canEdit   = canEditById[a.id]|default(false) %}
        {% set canDelete = canDeleteById[a.id]|default(false) %}

        {% set title = a.designation ?? '' %}
        {% if title is empty %}
          {% set title = a.lastName
            ? a.lastName ~ (a.firstName ? ' ' ~ a.firstName : '')
            : 'Entrée #' ~ a.id %}
        {% endif %}

        {% set addr1 = a.address ?? '' %}
        {% set addr2 = ((a.postalCode ?? '') ~ (a.city ? ' ' ~ a.city : ''))|trim %}
        {% set addr  = (addr1 ? addr1 : '') ~ (addr1 and addr2 ? ' — ' : '') ~ (addr2 ? addr2 : '') %}

        <div class="dir-card">
          <div class="dir-main">
            {# Ligne 1 : Titre + site + étoiles #}
            <span class="dir-line1">
              <span class="dir-title">{{ title }}</span>
              {% if a.website %}
                <a class="dir-website" href="{{ a.website }}" target="_blank" rel="noopener">site&nbsp;web</a>
              {% endif %}
              <span class="dir-stars" title="Note">
                {% set r = a.rating ?? 0 %}
                {% for i in 1..5 %}
                  {% if i <= r %}
                    <span class="dir-star dir-star--full">★</span>
                  {% else %}
                    <span class="dir-star">☆</span>
                  {% endif %}
                {% endfor %}
              </span>
            </span>

            {# Ligne 2 : Catégorie • Type — Adresse — Description (début) #}
            <span class="dir-line2">
              {% if a.category %}<span class="dir-pill">{{ a.category }}</span>{% endif %}
              {% if a.type %}<span class="dir-pill">{{ a.type }}</span>{% endif %}
              {% if addr %}<span class="dir-dash">—</span><span>{{ addr }}</span>{% endif %}
              {% if a.description %}<span class="dir-dash">—</span><span>{{ a.description }}</span>{% endif %}
            </span>
          </div>

          <div class="dir-actions">
            {% if a.email %}
              <a class="btn btn-sm btn-outline-secondary btn-skinny" href="mailto:{{ a.email }}">Email</a>
            {% endif %}
            {% if a.phone %}
              <a class="btn btn-sm btn-outline-secondary btn-skinny"
                 href="tel:{{ a.phone|replace({' ':'','-':'','.' : ''}) }}">Appeler</a>
            {% endif %}
            {% if canEdit %}
              <a class="btn btn-sm btn-outline-secondary btn-skinny" href="{{ path('annuaire_edit', { id: a.id }) }}">Modifier</a>
            {% endif %}
            {% if canDelete %}
              <form method="post"
                    action="{{ path('annuaire_delete', { id: a.id }) }}"
                    onsubmit="return confirm('Supprimer définitivement cette adresse ?');"
                    class="d-inline">
                <input type="hidden" name="_token" value="{{ csrf_token('annuaire_delete_' ~ a.id) }}">
                <button type="submit" class="btn btn-sm btn-outline-danger btn-skinny">Supprimer</button>
              </form>
            {% endif %}
          </div>
        </div>

      {% endfor %}
    </div>
  {% endif %}
</div>
{% endblock %}
