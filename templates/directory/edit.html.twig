{% extends 'base.html.twig' %}
{% block title %}Modifier l’adresse{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    .stars { display:inline-flex; gap:.25rem; cursor:pointer; vertical-align:middle; }
    .star { font-size:1.35rem; line-height:1; user-select:none; }
    .star.filled { color:#DAA520; } /* doré */
    .star.empty  { color:#cbd5e1; } /* gris clair */
    .hint { font-size:.85rem; color:#6b7280; margin-left:.5rem; }
  </style>
{% endblock %}

{% block body %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 m-0">Modifier l’adresse</h1>
    <a class="btn btn-outline-secondary" href="{{ path('annuaire_index') }}">Quitter</a>
  </div>

  {% for msg in app.flashes('success') %}
    <div class="alert alert-success">{{ msg }}</div>
  {% endfor %}
  {% for msg in app.flashes('danger') %}
    <div class="alert alert-danger">{{ msg }}</div>
  {% endfor %}

  {{ form_start(form) }}

    <div class="row g-3">
      <div class="col-md-6">{{ form_row(form.category) }}</div>
      <div class="col-md-6">{{ form_row(form.type) }}</div>

      <div class="col-md-6">{{ form_row(form.designation) }}</div>
      <div class="col-md-6">{{ form_row(form.website) }}</div>

      <div class="col-md-4">{{ form_row(form.lastName) }}</div>
      <div class="col-md-4">{{ form_row(form.firstName) }}</div>
      <div class="col-md-4">{{ form_row(form.phone) }}</div>

      <div class="col-12">{{ form_row(form.address) }}</div>

      <div class="col-md-4">{{ form_row(form.postalCode) }}</div>
      <div class="col-md-4">{{ form_row(form.city) }}</div>
      <div class="col-md-4">{{ form_row(form.email) }}</div>

      <div class="col-12">{{ form_row(form.description) }}</div>

      {# ---- NOTE / ÉTOILES ---- #}
      <div class="col-12">
        <label class="form-label d-block">Évaluation</label>

        {# on cache l'input natif pour laisser la main aux étoiles #}
        <div class="d-none">
          {{ form_widget(form.rating, {'attr': {'id': form.rating.vars.id ~ '_hidden'}}) }}
        </div>

        {# barre d’étoiles liée à l’input : pré-remplie via data-value #}
        {% set current = form.rating.vars.data ?? 0 %}
        <div
          id="stars"
          class="stars"
          data-input="{{ form.rating.vars.id ~ '_hidden' }}"
          data-value="{{ current|default(0) }}"
          aria-label="Note de 0 à 5"
        >
          {% for i in 1..5 %}
            {% set filled = i <= current %}
            <span class="star {{ filled ? 'filled' : 'empty' }}" data-v="{{ i }}" title="{{ i }} / 5">
              ★
            </span>
          {% endfor %}
        </div>

        <span class="hint">(cliquez pour ajuster la note)</span>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button class="btn btn-primary">Enregistrer</button>
      <a class="btn btn-outline-secondary" href="{{ path('annuaire_index') }}">Annuler</a>
    </div>

  {{ form_end(form) }}
</div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script>
    (function() {
      const wrap = document.getElementById('stars');
      if (!wrap) return;

      const inputId = wrap.getAttribute('data-input');
      const hidden = document.getElementById(inputId);
      if (!hidden) return;

      function render(val){
        wrap.querySelectorAll('.star').forEach(st => {
          const v = parseInt(st.getAttribute('data-v'), 10);
          st.classList.toggle('filled', v <= val);
          st.classList.toggle('empty',  v >  val);
        });
      }

      // Pré-remplissage depuis la valeur du formulaire (édition)
      let current = parseInt(wrap.getAttribute('data-value') || '0', 10);
      if (isNaN(current)) current = 0;
      hidden.value = current;
      render(current);

      // Clic utilisateur => MAJ input + rendu
      wrap.addEventListener('click', (e) => {
        const st = e.target.closest('.star');
        if (!st) return;
        const v = parseInt(st.getAttribute('data-v'), 10);
        if (isNaN(v)) return;
        hidden.value = String(v);
        render(v);
      });
    })();
  </script>
{% endblock %}
